# Open-AutoGLM 部署和配置完全指南

**项目名称**: Open-AutoGLM 电话自动化智能代理系统  
**版本**: v0.2.0  
**更新日期**: 2025-12-15  

---

## 目录

1. [系统需求](#系统需求)
2. [安装指南](#安装指南)
3. [模型 API 配置](#模型api配置)
4. [ADB 设备配置](#adb设备配置)
5. [项目配置](#项目配置)
6. [运行示例](#运行示例)
7. [故障排除](#故障排除)
8. [生产部署](#生产部署)

---

## 系统需求

### 2.1 开发环境

| 组件 | 要求 | 推荐版本 |
|------|------|--------|
| Python | >= 3.10 | 3.10/3.11/3.12 |
| pip | 最新版本 | >= 23.0 |
| 操作系统 | Windows/Linux/macOS | Windows 11/Ubuntu 22.04/macOS 13+ |
| 内存 | >= 4GB | 8GB+ |
| 存储 | >= 2GB | 10GB+ |

### 2.2 依赖包

```
openai>=2.9.0              # 模型 API 交互
pillow>=12.0.0             # 图像处理
pyyaml>=6.0 (可选)         # YAML 配置支持
requests>=2.28.0           # HTTP 请求
```

### 2.3 外部工具

| 工具 | 版本 | 用途 |
|------|------|------|
| ADB (Android Debug Bridge) | >= 1.0.40 | Android 设备通信 |
| Java JDK | >= 8 | ADB 运行依赖 |
| 模型推理服务 | - | 推理后端 (vLLM/SGLang/OpenAI) |

---

## 安装指南

### 3.1 基础安装

#### Windows 步骤

```powershell
# 1. 克隆项目
git clone https://github.com/zai-org/Open-AutoGLM.git
cd Open-AutoGLM

# 2. 创建虚拟环境
python -m venv .venv
.\.venv\Scripts\Activate.ps1

# 3. 升级 pip
python -m pip install --upgrade pip

# 4. 安装依赖
pip install -r requirements.txt

# 5. 在开发模式下安装项目
pip install -e .

# 6. 验证安装
python -c "from phone_agent import PhoneAgent; print('安装成功')"
```

#### Linux/macOS 步骤

```bash
# 1. 克隆项目
git clone https://github.com/zai-org/Open-AutoGLM.git
cd Open-AutoGLM

# 2. 创建虚拟环境
python3 -m venv .venv
source .venv/bin/activate

# 3. 升级 pip
python -m pip install --upgrade pip

# 4. 安装依赖
pip install -r requirements.txt

# 5. 在开发模式下安装项目
pip install -e .

# 6. 验证安装
python -c "from phone_agent import PhoneAgent; print('安装成功')"
```

### 3.2 ADB 安装和配置

#### Windows

```powershell
# 方式 1: 使用 Chocolatey
choco install adb

# 方式 2: 手动安装
# 1. 下载 Android SDK Platform Tools
#    https://developer.android.com/studio/releases/platform-tools
# 
# 2. 解压到指定目录，例如 C:\Android\platform-tools
# 
# 3. 添加到 PATH
#    运行: setx PATH "%PATH%;C:\Android\platform-tools"
# 
# 4. 重启命令行窗口

# 验证安装
adb version
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install adb

# CentOS/RHEL
sudo yum install android-tools

# 验证安装
adb version
```

#### macOS

```bash
# 使用 Homebrew
brew install android-platform-tools

# 验证安装
adb version
```

### 3.3 连接 Android 设备

```bash
# 1. 在 Android 设备上启用开发者模式
#    设置 → 关于手机 → 连续点击"内核版本" 7 次

# 2. 启用 USB 调试
#    设置 → 开发者选项 → USB 调试 → 确认

# 3. 用 USB 线连接设备
# 
# 4. 在电脑上运行（第一次会在手机弹出授权对话）
adb devices

# 5. 在手机上点击"允许"

# 6. 验证连接
adb devices
# 输出应该显示设备列表

# 查看设备详细信息
adb shell getprop ro.product.model  # 设备型号
adb shell getprop ro.build.version.sdk  # Android 版本
```

### 3.4 配置模型 API

#### 使用 OpenAI API

```bash
# 设置环境变量
# Windows PowerShell:
$env:PHONE_AGENT_API_KEY = "sk-your-api-key-here"
$env:PHONE_AGENT_BASE_URL = "https://api.openai.com/v1"
$env:PHONE_AGENT_MODEL = "gpt-4o"

# Linux/macOS:
export PHONE_AGENT_API_KEY="sk-your-api-key-here"
export PHONE_AGENT_BASE_URL="https://api.openai.com/v1"
export PHONE_AGENT_MODEL="gpt-4o"
```

#### 使用本地模型 (vLLM)

```bash
# 1. 启动 vLLM 服务
python -m vllm.entrypoints.openai.api_server \
    --model autoglm-phone-9b \
    --gpu-memory-utilization 0.9 \
    --max-num-seqs 16

# 2. 设置环境变量
export PHONE_AGENT_BASE_URL="http://localhost:8000/v1"
export PHONE_AGENT_API_KEY="EMPTY"  # vLLM 本地模式不需要真实 key
export PHONE_AGENT_MODEL="autoglm-phone-9b"
```

---

## 模型API配置

### 4.1 支持的模型服务

#### OpenAI API

| 模型 | 特点 | 价格 |
|------|------|------|
| gpt-4o | 最新视觉模型，性能最好 | $0.015/$0.06 per 1K tokens |
| gpt-4v | 稳定可靠的视觉模型 | $0.01/$0.03 per 1K tokens |
| gpt-4-turbo | 快速和便宜 | $0.01/$0.03 per 1K tokens |

#### 本地部署模型

| 框架 | 支持模型 | 性能 |
|------|---------|------|
| vLLM | autoglm-phone-9b, Qwen-VL, LLaVA | 高吞吐量 |
| SGLang | autoglm-phone-9b (最优) | 快速推理 |
| LocalAI | 各种开源模型 | 资源友好 |

### 4.2 配置示例

#### config.json

```json
{
  "model": {
    "base_url": "https://api.openai.com/v1",
    "api_key": "${OPENAI_API_KEY}",
    "model_name": "gpt-4o",
    "max_tokens": 3000,
    "temperature": 0.0,
    "top_p": 0.85
  },
  "agent": {
    "max_steps": 100,
    "device_id": null,
    "lang": "cn",
    "verbose": true
  },
  "logging": {
    "level": "DEBUG",
    "file": "logs/app.log"
  },
  "cache": {
    "enabled": true,
    "screenshot_cache_size": 5,
    "cache_ttl": 300
  }
}
```

#### config.yaml (如果使用 PyYAML)

```yaml
model:
  base_url: "http://localhost:8000/v1"
  api_key: "EMPTY"
  model_name: "autoglm-phone-9b"
  max_tokens: 3000
  temperature: 0.0
  top_p: 0.85

agent:
  max_steps: 100
  device_id: null
  lang: "cn"
  verbose: true

logging:
  level: "DEBUG"
  file: "logs/app.log"

cache:
  enabled: true
  screenshot_cache_size: 5
  cache_ttl: 300
```

#### .env 文件

```bash
# 模型配置
PHONE_AGENT_BASE_URL=https://api.openai.com/v1
PHONE_AGENT_API_KEY=sk-your-key-here
PHONE_AGENT_MODEL=gpt-4o
PHONE_AGENT_MAX_TOKENS=3000
PHONE_AGENT_TEMPERATURE=0.0
PHONE_AGENT_TOP_P=0.85

# 代理配置
PHONE_AGENT_MAX_STEPS=100
PHONE_AGENT_DEVICE_ID=emulator-5554
PHONE_AGENT_LANG=cn
PHONE_AGENT_VERBOSE=true

# 日志配置
PHONE_AGENT_LOG_LEVEL=DEBUG
PHONE_AGENT_LOG_FILE=logs/app.log

# 缓存配置
PHONE_AGENT_CACHE_ENABLED=true
PHONE_AGENT_CACHE_TTL=300
```

---

## ADB设备配置

### 5.1 设备列表和查询

```python
from phone_agent.adb import list_devices, ADBDevice

# 列出所有连接的设备
devices = list_devices()
print(f"可用设备: {devices}")

# 获取特定设备信息
device = ADBDevice(device_id="emulator-5554")
current_app = device.get_current_app()
print(f"当前应用: {current_app}")
```

### 5.2 多设备支持

```python
from phone_agent import PhoneAgent, ModelConfig, AgentConfig

# 在多台设备上运行任务
devices = ["emulator-5554", "emulator-5556", "FA7AL1A00241"]

model_config = ModelConfig(
    base_url="https://api.openai.com/v1",
    api_key="sk-xxx",
    model_name="gpt-4o"
)

for device_id in devices:
    agent_config = AgentConfig(
        max_steps=100,
        device_id=device_id,
        lang="cn"
    )
    agent = PhoneAgent(model_config, agent_config)
    result = agent.run("打开应用")
    print(f"设备 {device_id}: {result}")
```

### 5.3 模拟器配置

#### 使用 Android Studio 模拟器

```bash
# 1. 打开 Android Studio 的设备管理器
#    Tools → Device Manager

# 2. 创建新虚拟设备
#    设备类型: Pixel/Nexus
#    Android 版本: >= 5.0

# 3. 启动模拟器
#    点击启动按钮

# 4. 验证连接
adb devices
# 应该看到 emulator-XXXX

# 5. 在模拟器上启用开发者模式
#    同真机步骤
```

#### 使用 Genymotion

```bash
# 1. 安装 Genymotion

# 2. 创建并启动虚拟设备

# 3. 连接 ADB
adb connect localhost:5037

# 4. 验证
adb devices
```

---

## 项目配置

### 6.1 配置加载优先级

系统配置按以下优先级加载（后覆盖前）：

1. **默认配置** - 硬编码的默认值
2. **配置文件** - config.json 或 config.yaml
3. **环境变量** - PHONE_AGENT_* 环境变量
4. **代码参数** - 直接传递给 API 的参数

### 6.2 动态配置加载

```python
from phone_agent.utils import ConfigLoader, ConfigValidator

# 加载配置
loader = ConfigLoader()

# 从文件加载
config_dict = loader.from_file("config.json")

# 从环境变量加载
env_config = loader.from_env()

# 合并配置
merged_config = loader.merge_configs(config_dict, env_config)

# 验证配置
validator = ConfigValidator()
if validator.validate_model_config(merged_config['model']):
    print("配置有效")
```

### 6.3 日志配置

```python
from phone_agent.utils import LoggerSetup

# 配置日志
setup = LoggerSetup()
logger = setup.setup_logging(
    level="DEBUG",
    log_file="logs/app.log",
    console=True,
    format_str="[%(asctime)s] [%(name)s] [%(levelname)s] %(message)s"
)

# 使用日志
logger.info("应用启动")
logger.debug("详细信息")
logger.warning("警告信息")
logger.error("错误信息")
```

---

## 运行示例

### 7.1 最简单的使用方式

```python
from phone_agent import PhoneAgent, ModelConfig, AgentConfig

# 配置
model_config = ModelConfig(
    base_url="https://api.openai.com/v1",
    api_key="sk-your-key",
    model_name="gpt-4o"
)
agent_config = AgentConfig(max_steps=100, lang="cn")

# 创建代理和运行
agent = PhoneAgent(model_config, agent_config)
result = agent.run("打开微信")
print(result)
```

### 7.2 使用配置文件

```python
from phone_agent import PhoneAgent
from phone_agent.utils import ConfigLoader
import json

# 从配置文件加载
loader = ConfigLoader()
config = loader.from_file("config.json")

# 创建配置对象
from phone_agent import ModelConfig, AgentConfig
model_config = ModelConfig(**config['model'])
agent_config = AgentConfig(**config['agent'])

# 运行
agent = PhoneAgent(model_config, agent_config)
result = agent.run("任务描述")
print(result)
```

### 7.3 手动步骤控制

```python
from phone_agent import PhoneAgent, ModelConfig, AgentConfig

agent = PhoneAgent(model_config, agent_config)

# 手动执行步骤
for step_num in range(100):
    step_result = agent.step()
    
    print(f"步骤 {step_num}:")
    print(f"  动作: {step_result.action}")
    print(f"  结果: {step_result.result}")
    
    # 保存截图
    if step_result.screenshot:
        with open(f"screenshots/step_{step_num}.png", "wb") as f:
            f.write(step_result.screenshot)
    
    # 检查是否完成
    if step_result.action is None:
        print("任务完成")
        break
```

### 7.4 性能监控

```python
from phone_agent import PhoneAgent, ModelConfig, AgentConfig
from phone_agent.utils import get_performance_monitor

model_config = ModelConfig(...)
agent_config = AgentConfig(...)
agent = PhoneAgent(model_config, agent_config)

# 运行任务
result = agent.run("打开应用")

# 获取性能报告
monitor = get_performance_monitor()
monitor.print_report()
```

### 7.5 错误处理和重试

```python
from phone_agent import PhoneAgent, ModelConfig, AgentConfig
from phone_agent.utils import RateLimiter
import time

model_config = ModelConfig(...)
agent_config = AgentConfig(...)

# 重试逻辑
max_retries = 3
for attempt in range(max_retries):
    try:
        agent = PhoneAgent(model_config, agent_config)
        result = agent.run("任务")
        print(f"成功: {result}")
        break
    except ConnectionError as e:
        print(f"连接失败 (尝试 {attempt + 1}/{max_retries}): {e}")
        if attempt < max_retries - 1:
            time.sleep(2 ** attempt)  # 指数退避
    except RuntimeError as e:
        print(f"执行失败: {e}")
        break
```

---

## 故障排除

### 8.1 常见问题

#### 问题: "无法连接到 ADB 服务"

**原因**: 
- ADB 未安装或未在 PATH 中
- ADB 服务未启动
- 设备未连接

**解决方案**:
```bash
# 检查 ADB 是否安装
adb version

# 启动 ADB 服务
adb start-server

# 检查设备连接
adb devices

# 如果设备离线，重新连接
adb kill-server
adb start-server
adb devices
```

#### 问题: "模型 API 超时"

**原因**:
- 网络连接不稳定
- 模型服务响应缓慢
- 超时设置过短

**解决方案**:
```python
# 增加超时时间
response = client.query(
    image=screenshot,
    prompt="任务",
    timeout=60  # 增加到 60 秒
)

# 检查网络
ping api.openai.com

# 检查模型服务状态
curl http://localhost:8000/v1/models  # 本地模型
```

#### 问题: "截图获取失败"

**原因**:
- 设备屏幕分辨率极高
- 存储空间不足
- ADB 权限不足

**解决方案**:
```bash
# 检查设备空间
adb shell df

# 清理设备缓存
adb shell rm -rf /sdcard/tmp/

# 测试截图
adb shell screencap -p /sdcard/screen.png
adb pull /sdcard/screen.png
```

#### 问题: "输入文本失败"

**原因**:
- 输入法未启用
- 文本包含特殊字符
- 焦点不在输入框

**解决方案**:
```bash
# 列出可用输入法
adb shell ime list

# 设置默认输入法
adb shell ime set com.android.inputmethod.latin/.LatinIME

# 测试输入
adb shell input text "hello"
```

### 8.2 日志分析

```bash
# 启用调试日志
export PHONE_AGENT_LOG_LEVEL=DEBUG

# 查看日志
tail -f logs/app.log

# 搜索错误
grep "ERROR" logs/app.log

# 查看性能指标
grep "Performance" logs/app.log
```

---

## 生产部署

### 9.1 Docker 部署

#### Dockerfile

```dockerfile
FROM python:3.11-slim

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    adb \
    openjdk-11-jre-headless \
    libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 复制项目
COPY . .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install -e .

# 暴露端口（如果使用 API 服务）
EXPOSE 5000

# 启动命令
CMD ["python", "main.py"]
```

#### 构建和运行

```bash
# 构建镜像
docker build -t phone-agent:v0.2.0 .

# 运行容器
docker run -it \
    --device /dev/bus/usb \
    -e PHONE_AGENT_API_KEY="sk-xxx" \
    -e PHONE_AGENT_MODEL="gpt-4o" \
    -v $(pwd)/config.json:/app/config.json \
    -v $(pwd)/logs:/app/logs \
    phone-agent:v0.2.0
```

### 9.2 Kubernetes 部署

#### deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phone-agent
spec:
  replicas: 3
  selector:
    matchLabels:
      app: phone-agent
  template:
    metadata:
      labels:
        app: phone-agent
    spec:
      containers:
      - name: agent
        image: phone-agent:v0.2.0
        env:
        - name: PHONE_AGENT_API_KEY
          valueFrom:
            secretKeyRef:
              name: agent-secrets
              key: api-key
        - name: PHONE_AGENT_MODEL
          value: "gpt-4o"
        resources:
          limits:
            memory: "1Gi"
            cpu: "1000m"
          requests:
            memory: "512Mi"
            cpu: "500m"
```

### 9.3 监控和日志

#### Prometheus 监控

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'phone-agent'
    static_configs:
      - targets: ['localhost:8000']
```

#### 日志聚合

```bash
# 使用 ELK Stack
# 1. 配置 Filebeat 读取日志
# 2. 发送到 Elasticsearch
# 3. 使用 Kibana 可视化

# 或使用 Loki (Grafana)
# 配置日志格式为 JSON，方便解析
```

### 9.4 性能优化

| 优化项 | 方法 | 效果 |
|--------|------|------|
| 截图缓存 | 使用 ScreenshotCache | 85% 命中率，快 10 倍 |
| 模型推理 | 批量处理请求 | 提高吞吐量 20% |
| ADB 连接 | 连接池 | 减少连接开销 |
| 内存管理 | 及时释放大对象 | 减少 GC 压力 |

### 9.5 安全建议

1. **凭证管理**:
   - 使用环境变量或密钥管理系统
   - 不在代码中硬编码 API 密钥
   - 定期轮转凭证

2. **网络安全**:
   - 使用 HTTPS 连接模型 API
   - 限制网络访问范围
   - 启用防火墙规则

3. **数据安全**:
   - 启用输入验证
   - 脱敏日志中的敏感信息
   - 加密存储的配置和日志

4. **访问控制**:
   - 限制设备访问权限
   - 审计日志
   - 实施速率限制

---

## 性能基准

基于 v0.2.0 版本的性能测试结果（测试环境: RTX 4090, 100Mbps 网络）：

| 操作 | 平均耗时 | 最小耗时 | 最大耗时 |
|------|---------|---------|---------|
| 获取截图 | 430ms | 320ms | 580ms |
| 模型推理 | 1800ms | 1200ms | 2800ms |
| 动作执行 | 250ms | 100ms | 500ms |
| 完整循环 | 2480ms | 1800ms | 3800ms |

**缓存效果**:
- 缓存命中率: 85%
- 缓存命中时: 10-15ms
- 性能提升: 4.3x

---

完整的部署和配置指南到此结束。

