# Open-AutoGLM 系统数据流与架构图

**项目名称**: Open-AutoGLM 电话自动化智能代理系统  
**版本**: v0.2.0  
**日期**: 2025-12-15  

---

## 目录

1. [系统架构图](#系统架构图)
2. [数据流图（DFD）](#数据流图dfd)
3. [时序图](#时序图)
4. [状态机](#状态机)
5. [部署架构](#部署架构)

---

## 系统架构图

### 1.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                        用户层 (User Layer)                      │
│                        ┌─────────────┐                          │
│                        │ CLI/Python  │                          │
│                        │ API 调用    │                          │
│                        └──────┬──────┘                          │
│                               │                                 │
└───────────────────────────────┼─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                                                                 │
│                    业务逻辑层 (Logic Layer)                     │
│               ┌───────────────────────────────┐                 │
│               │      PhoneAgent (代理)        │                 │
│               ├───────────────────────────────┤                 │
│               │ • 任务编排                    │                 │
│               │ • 步骤执行循环                │                 │
│               │ • 状态管理                    │                 │
│               │ • 错误处理                    │                 │
│               └───────────────────────────────┘                 │
│                                                                 │
└──┬─────────────────────────────────────────────────────────┬───┘
   │                                                         │
   │                                                         │
   │ 交互 API                                              │ 交互 API
   │                                                         │
┌──▼──────────────┐                          ┌──────────────▼──┐
│ 模型交互层      │                          │ 设备控制层      │
├─────────────────┤                          ├─────────────────┤
│ ModelClient     │                          │ ADBDevice       │
│ ModelConfig     │                          │ ADBConnection   │
│                 │                          │                 │
│ • API 初始化    │                          │ • 连接管理      │
│ • 请求构建      │                          │ • 命令执行      │
│ • 响应解析      │                          │ • 截图获取      │
│ • 异常处理      │                          │ • 输入操作      │
│ • 日志记录      │                          │ • 设备查询      │
└──┬──────────────┘                          └──────────┬──────┘
   │                                                    │
   │                                                    │
└───┼────────────────────────────────────────────────┬──┘
    │                                                │
    │ 序列化/反序列化      │ 命令下发
    │                      │
    │ ┌──────────────────────────────────────┐
    │ │  动作处理层 (Actions Layer)         │
    │ │  ┌────────────────────────────────┐  │
    │ │  │ ActionHandler                  │  │
    │ │  │ • 动作解析 (JSON/AST/Regex)   │  │
    │ │  │ • 动作验证                     │  │
    │ │  │ • 14+ 动作处理器               │  │
    │ │  │ • 执行调用                     │  │
    │ │  └────────────────────────────────┘  │
    │ └──────────────┬───────────────────────┘
    │               │
    │         命令执行 │
    │               │
    ├───────────────┴────────────────────────────────────────┐
    │                                                        │
    │          工具和支撑层 (Support Layer)                  │
    │  ┌────────────────────────────────────────────────┐   │
    │  │                                                │   │
    │  │  ┌─────────────┐  ┌─────────────────────────┐ │   │
    │  │  │ 缓存管理    │  │ 配置管理                │ │   │
    │  │  │ (cache.py)  │  │ (config.py)            │ │   │
    │  │  │             │  │                         │ │   │
    │  │  │ SimpleCache │  │ ConfigValidator         │ │   │
    │  │  │ Screenshot  │  │ ConfigLoader            │ │   │
    │  │  │ Cache       │  │ SecureConfig            │ │   │
    │  │  └─────────────┘  └─────────────────────────┘ │   │
    │  │                                                │   │
    │  │  ┌─────────────┐  ┌─────────────────────────┐ │   │
    │  │  │ 日志和监控  │  │ 安全和验证              │ │   │
    │  │  │ (monitoring)│  │ (security.py)           │ │   │
    │  │  │             │  │                         │ │   │
    │  │  │ LoggerSetup │  │ InputValidator          │ │   │
    │  │  │ Performance │  │ SensitiveDataFilter     │ │   │
    │  │  │ Monitor     │  │ RateLimiter             │ │   │
    │  │  └─────────────┘  └─────────────────────────┘ │   │
    │  │                                                │   │
    │  │  ┌─────────────┐  ┌─────────────────────────┐ │   │
    │  │  │ 性能指标    │  │ 通用工具                │ │   │
    │  │  │ (metrics.py)│  │                         │ │   │
    │  │  │             │  │ • 类型转换              │ │   │
    │  │  │ StepMetrics │  │ • 数据格式化            │ │   │
    │  │  │ SessionM... │  │ • 路径处理              │ │   │
    │  │  │ Collector   │  │ • 异常定义              │ │   │
    │  │  └─────────────┘  └─────────────────────────┘ │   │
    │  │                                                │   │
    │  └────────────────────────────────────────────────┘   │
    │                                                        │
    └────────────────────────────────────────────────────────┘
                          │
                          │ 外部依赖
                          │
┌─────────────────────────┼─────────────────────────────────┐
│                         │                                 │
│  ┌────────────────────┐ │ ┌──────────────────────────────┐│
│  │  OpenAI API        │◄┼─┤ 网络连接 (HTTP/HTTPS)       ││
│  │ (或兼容的模型API)  │ │ │ • TCP/IP                     ││
│  │                    │ │ │ • TLS 加密                   ││
│  │ 视觉语言模型       │ │ └──────────────────────────────┘│
│  │ - 推理             │ │                                 │
│  │ - 图像理解         │ │ ┌──────────────────────────────┐│
│  │ - 动作生成         │ │ │ Android 设备                 ││
│  │                    │ │ │ (或模拟器)                   ││
│  │ 参数:              │ │ │                              ││
│  │ - max_tokens: 3000 │ │ │ • ADB 端口 5037             ││
│  │ - temperature: 0.0 │ │ │ • USB/TCP 连接              ││
│  │ - top_p: 0.85      │ │ │ • 屏幕分辨率支持            ││
│  │                    │ │ │ • API 21+ (Android 5.0+)    ││
│  │ 返回:              │ │ │                              ││
│  │ - JSON 格式动作    │ │ │ 支持的操作:                 ││
│  │ - 完成标志         │ │ │ • screencap (截图)         ││
│  │ - 错误消息         │ │ │ • input (输入)              ││
│  │                    │ │ │ • shell (命令)              ││
│  │                    │ │ │ • am (应用管理)             ││
│  │                    │ │ │ • dumpsys (系统信息)        ││
│  │                    │ │ │                              ││
│  │                    │ │ │ 可用的输入:                 ││
│  │                    │ │ │ • tap (点击)                ││
│  │                    │ │ │ • swipe (滑动)              ││
│  │                    │ │ │ • text (输入文本)           ││
│  │                    │ │ │ • keyevent (按键)           ││
│  │                    │ │ └──────────────────────────────┘│
│  │                    │ │                                 │
│  └────────────────────┘ │                                 │
│                         │                                 │
│                         └────────────────────────────────→│
│                                                            │
│                     外部系统 (External Systems)           │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 1.2 模块通信关系图

```
                    PhoneAgent (核心编排)
                         │
        ┌────────────────┼────────────────┬─────────────┐
        │                │                │             │
        ▼                ▼                ▼             ▼
    ModelClient      ADBDevice      ActionHandler    配置验证
        │                │                │             │
        │                │                │         (运行时)
        │                │ ┌──────────────┼─┐
        │                │ │              │ │
        ├────────────────┤─┘              │ │
        │   API 调用     │                │ │
        │   (请求-响应)  │    ┌───────────┤ │
        │                │    │动作解析   │ │
        ▼                ▼    ▼           ▼ ▼
    OpenAI API      ADB 命令  14+ 处理器  ConfigValidator

    ┌─────────────────────────────────────────────────────┐
    │              通用工具层 (横跨所有模块)              │
    ├─────────────────────────────────────────────────────┤
    │                                                     │
    │ ┌──────────────────────────────────────────────┐   │
    │ │ 日志系统 (LoggerSetup)                       │   │
    │ │ • 为所有模块提供统一日志                     │   │
    │ │ • 支持多个日志处理器                         │   │
    │ │ • 自动脱敏敏感信息                           │   │
    │ └──────────────────────────────────────────────┘   │
    │                                                     │
    │ ┌──────────────────────────────────────────────┐   │
    │ │ 缓存系统 (SimpleCache/ScreenshotCache)       │   │
    │ │ • 减少 API 和 ADB 调用                        │   │
    │ │ • 提供性能优化                               │   │
    │ └──────────────────────────────────────────────┘   │
    │                                                     │
    │ ┌──────────────────────────────────────────────┐   │
    │ │ 安全验证 (InputValidator/SensitiveFilter)    │   │
    │ │ • 防止安全漏洞                               │   │
    │ │ • 保护用户隐私                               │   │
    │ └──────────────────────────────────────────────┘   │
    │                                                     │
    │ ┌──────────────────────────────────────────────┐   │
    │ │ 配置管理 (ConfigLoader/ConfigValidator)      │   │
    │ │ • 灵活的配置加载                             │   │
    │ │ • 自动参数验证                               │   │
    │ └──────────────────────────────────────────────┘   │
    │                                                     │
    │ ┌──────────────────────────────────────────────┐   │
    │ │ 性能监控 (PerformanceMonitor/MetricsCollector)   │   │
    │ │ • 操作计时                                   │   │
    │ │ • 性能统计                                   │   │
    │ │ • 性能报告                                   │   │
    │ └──────────────────────────────────────────────┘   │
    │                                                     │
    └─────────────────────────────────────────────────────┘
```

### 1.3 包和类的关系图

```
phone_agent (包)
│
├─── __init__.py
│    ├─ 导出: PhoneAgent, StepResult
│    ├─ 导出: ModelConfig, AgentConfig
│    ├─ 导出: ConfigValidator, ConfigLoader
│    ├─ 导出: SessionMetrics, StepMetrics
│    └─ 导出: LoggerSetup, get_performance_monitor
│
├─── agent.py
│    ├─ PhoneAgent (main orchestrator)
│    │  ├─ __init__(model_config, agent_config)
│    │  ├─ run(task: str) -> str
│    │  ├─ step() -> StepResult
│    │  └─ reset()
│    │
│    ├─ AgentConfig (dataclass)
│    │  ├─ max_steps: int
│    │  ├─ device_id: Optional[str]
│    │  ├─ lang: str
│    │  └─ verbose: bool
│    │
│    └─ StepResult (dataclass)
│       ├─ action: Optional[str]
│       ├─ result: str
│       └─ screenshot: Optional[bytes]
│
├─── model/ (子包)
│    ├─ __init__.py
│    │  └─ 导出: ModelConfig, ModelClient
│    │
│    └─ client.py
│       ├─ ModelClient (class)
│       │  ├─ __init__(config: ModelConfig)
│       │  └─ query(image: bytes, prompt: str) -> str
│       │
│       └─ ModelConfig (dataclass)
│          ├─ base_url: str
│          ├─ api_key: str
│          ├─ model_name: str
│          ├─ max_tokens: int
│          ├─ temperature: float
│          ├─ top_p: float
│          └─ __post_init__()  # 验证
│
├─── actions/ (子包)
│    ├─ __init__.py
│    │  └─ 导出: ActionHandler, parse_action
│    │
│    └─ handler.py
│       ├─ ActionHandler (class)
│       │  ├─ parse_action(response: str) -> dict
│       │  └─ handle_action(action: dict) -> None
│       │
│       ├─ 14+ 动作处理函数
│       │  ├─ launch_app()
│       │  ├─ tap()
│       │  ├─ swipe()
│       │  ├─ send_text()
│       │  ├─ press_key()
│       │  └─ ...
│       │
│       └─ 辅助函数
│          └─ _get_handler(), get_app_packages()
│
├─── adb/ (子包)
│    ├─ __init__.py
│    │  └─ 导出: ADBDevice, list_devices
│    │
│    ├─ connection.py
│    │  ├─ ADBConnection (class)
│    │  │  ├─ __init__()
│    │  │  ├─ connect()
│    │  │  ├─ disconnect()
│    │  │  └─ execute_command()
│    │  │
│    │  └─ DeviceInfo (dataclass)
│    │     ├─ device_id: str
│    │     ├─ product: str
│    │     ├─ device: str
│    │     └─ model: str
│    │
│    ├─ device.py
│    │  ├─ ADBDevice (class)
│    │  │  ├─ __init__(device_id=None)
│    │  │  ├─ get_screenshot() -> Screenshot
│    │  │  ├─ get_current_app() -> str
│    │  │  ├─ tap(), swipe(), send_text()
│    │  │  ├─ press_key(), launch_app()
│    │  │  └─ list_devices() -> list
│    │  │
│    │  └─ Screenshot (dataclass)
│    │     ├─ data: bytes
│    │     ├─ width: int
│    │     └─ height: int
│    │
│    ├─ screenshot.py
│    │  ├─ get_screenshot()
│    │  └─ decode_screenshot()
│    │
│    └─ input.py
│       ├─ tap(), swipe()
│       ├─ send_text()
│       └─ press_key()
│
└─── utils/ (子包)
     ├─ __init__.py
     │  ├─ 导出: SimpleCache, ScreenshotCache
     │  ├─ 导出: ConfigValidator, ConfigLoader
     │  ├─ 导出: LoggerSetup, get_performance_monitor
     │  ├─ 导出: InputValidator, SensitiveDataFilter, RateLimiter
     │  └─ 导出: StepMetrics, SessionMetrics, MetricsCollector
     │
     ├─ cache.py
     │  ├─ SimpleCache (class)
     │  │  ├─ get(), set(), clear()
     │  │  └─ get_stats()
     │  │
     │  └─ ScreenshotCache (class)
     │     ├─ get(), set(), is_different()
     │     └─ clear()
     │
     ├─ config.py
     │  ├─ ConfigValidator (class)
     │  │  ├─ validate_model_config()
     │  │  ├─ validate_agent_config()
     │  │  └─ validate_env_vars()
     │  │
     │  ├─ ConfigLoader (class)
     │  │  ├─ from_env()
     │  │  ├─ from_file()
     │  │  └─ merge_configs()
     │  │
     │  └─ SecureConfig (class)
     │     ├─ load_from_env()
     │     ├─ mask_sensitive_value()
     │     └─ log_config_summary()
     │
     ├─ monitoring.py
     │  ├─ LoggerSetup (class)
     │  │  ├─ setup_logging()
     │  │  └─ get_logger()
     │  │
     │  ├─ PerformanceMonitor (class)
     │  │  ├─ start_timer(), end_timer()
     │  │  ├─ get_metrics(), get_average()
     │  │  └─ print_report()
     │  │
     │  └─ get_performance_monitor() (函数)
     │
     ├─ security.py
     │  ├─ InputValidator (class)
     │  │  ├─ validate_text_input()
     │  │  ├─ sanitize_app_name()
     │  │  └─ sanitize_coordinates()
     │  │
     │  ├─ SensitiveDataFilter (class)
     │  │  ├─ mask_sensitive_data()
     │  │  └─ filter_log_message()
     │  │
     │  └─ RateLimiter (class)
     │     ├─ is_allowed()
     │     └─ get_reset_time()
     │
     └─ metrics.py
        ├─ StepMetrics (dataclass)
        │  ├─ screenshot_time, model_inference_time
        │  ├─ action_execution_time, total_time
        │  ├─ to_dict()
        │  └─ __str__()
        │
        ├─ SessionMetrics (dataclass)
        │  ├─ total_steps, total_time, steps
        │  ├─ add_step(), finalize()
        │  ├─ get_average_times()
        │  ├─ to_dict()
        │  └─ print_summary()
        │
        └─ MetricsCollector (class)
           ├─ __enter__(), __exit__()
           ├─ elapsed (property)
           └─ elapsed_ms (property)
```

---

## 数据流图（DFD）

### 2.1 DFD Level 0 - 系统上下文

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                     用户 (User)                            │
│                                                             │
│  • 输入: 自然语言任务描述                                   │
│  • 输出: 任务执行结果和报告                                │
│                                                             │
└──────────┬──────────────────────────────────┬──────────────┘
           │                                  │
      指令│                              │结果报告
           │                                  │
           ▼                                  ▼
    ┌─────────────────────────────┐
    │   Open-AutoGLM 系统         │
    │  (Phone Agent System)       │
    │                             │
    │ • 理解用户意图              │
    │ • 与设备交互                │
    │ • 执行自动化任务            │
    │                             │
    └────┬────────────────┬───────┘
         │                │
    API调用│          设备命令│
         │                │
         ▼                ▼
    ┌──────────────┐  ┌───────────┐
    │  LLM API     │  │ Android   │
    │  服务        │  │ 设备      │
    │              │  │           │
    │ • 图像分析   │  │ • 屏幕    │
    │ • 动作生成   │  │ • 输入    │
    │              │  │ • 输出    │
    └──────────────┘  └───────────┘
```

### 2.2 DFD Level 1 - 核心流程

```
数据流: 任务执行流
┌──────────┐
│  用户    │
│  任务    │
└────┬─────┘
     │ "打开微信"
     ▼
┌──────────────────┐
│  输入验证        │ ◄── 配置验证
│  (InputValidator)│
└────┬─────────────┘
     │ 验证通过
     ▼
┌──────────────────┐
│  初始化          │ ◄── ConfigLoader
│  (AgentConfig)   │
└────┬─────────────┘
     │
     ▼
┌──────────────────────────────────────┐
│  核心循环: while 未完成               │
│  ┌────────────────────────────────┐  │
│  │ 1. 获取截图                   │  │
│  │    Device.get_screenshot()     │  │
│  │ ┌─────────────────────────────┐│  │
│  │ │ 检查ScreenshotCache         ││  │
│  │ └─────────────────────────────┘│  │
│  └────────────────────────────────┘  │
│         │                             │
│         ▼ (图像数据)                  │
│  ┌────────────────────────────────┐  │
│  │ 2. AI 推理                     │  │
│  │    ModelClient.query()         │  │
│  │ ┌─────────────────────────────┐│  │
│  │ │ HTTP POST -> OpenAI API     ││  │
│  │ │ 参数: 图像 + 任务描述        ││  │
│  │ └─────────────────────────────┘│  │
│  └────────────────────────────────┘  │
│         │                             │
│         ▼ (JSON 动作)                 │
│  ┌────────────────────────────────┐  │
│  │ 3. 解析动作                    │  │
│  │    ActionHandler.parse_action()│  │
│  │ ┌─────────────────────────────┐│  │
│  │ │ JSON/AST/Regex 解析         ││  │
│  │ └─────────────────────────────┘│  │
│  └────────────────────────────────┘  │
│         │                             │
│         ▼ (动作字典)                  │
│  ┌────────────────────────────────┐  │
│  │ 4. 执行动作                    │  │
│  │    ActionHandler.handle()      │  │
│  │ ┌─────────────────────────────┐│  │
│  │ │ ADB 命令执行                ││  │
│  │ │ 例: input tap x y           ││  │
│  │ └─────────────────────────────┘│  │
│  └────────────────────────────────┘  │
│         │                             │
│         ▼ (执行结果)                  │
│  ┌────────────────────────────────┐  │
│  │ 5. 更新状态 & 记录指标        │  │
│  │    + PerformanceMonitor        │  │
│  │    + LoggerSetup               │  │
│  └────────────────────────────────┘  │
│         │                             │
└─────────┼──────────────────────────────┘
          │ 继续迭代或完成
          ▼
┌──────────────────┐
│  返回结果        │
│  (成功/失败)     │
└──────────┬───────┘
           │
           ▼
┌──────────────────┐
│  用户            │
│  (结果报告)      │
└──────────────────┘
```

### 2.3 DFD Level 2 - 模型交互

```
ModelClient.query(image, prompt)

输入:
├─ image: bytes (PNG 编码的截图)
└─ prompt: str (自然语言提示)

处理流程:
┌─────────────────────────┐
│ 1. 编码图像             │
│    base64_image =       │
│    b64encode(image)     │
└────────────┬────────────┘
             │
┌────────────▼────────────┐
│ 2. 构建请求体           │
│ {                       │
│   "model": "...",       │
│   "messages": [         │
│     {                   │
│       "role": "user",   │
│       "content": [      │
│         {              │
│           "type":      │
│           "image_url", │
│           "image_url": │
│             "data:..." │
│         },             │
│         {              │
│           "type":      │
│           "text",      │
│           "text": "..."│
│         }              │
│       ]                │
│     }                  │
│   ],                   │
│   "max_tokens": 3000   │
│ }                       │
└────────────┬────────────┘
             │
┌────────────▼────────────────────────┐
│ 3. 发送 HTTP 请求                   │
│    POST base_url/v1/chat/completions│
│    Headers:                         │
│    - Authorization: Bearer <key>    │
│    - Content-Type: application/json │
└────────────┬────────────────────────┘
             │ (网络延迟 1-5s)
┌────────────▼────────────────────────┐
│ 4. 接收流式响应                     │
│    逐块处理 (SSE: Server-Sent Event)│
│    拼接 content 字段                │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│ 5. 提取响应内容                     │
│    response = "{"                   │
│    "_metadata": "do", ...}"         │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│ 6. 验证响应 (非空检查)              │
│    if not response:                 │
│      raise ValueError(...)          │
└────────────┬────────────────────────┘
             │
┌────────────▼────────────────────────┐
│ 7. 记录日志                         │
│    logger.debug(response)           │
└────────────┬────────────────────────┘
             │
输出:
└─ response: str (JSON 格式动作)
```

### 2.4 DFD Level 2 - 设备交互

```
ADBDevice 操作流

操作: get_screenshot()
输入: device_id (可选)
处理:
  ┌─────────────────────┐
  │ 1. 检查缓存         │
  │    ScreenshotCache  │
  └────┬─────────┬──────┘
       │缓存中  │无缓存
       │       │
    ┌──▼┐    ┌──▼──────────────┐
    │返回│    │ 2. 执行 ADB     │
    └────┘    │    screencap    │
              │ adb shell       │
              │ screencap -p    │
              │ /sdcard/tmp.png │
              └────┬────────────┘
                   │ (PNG 字节)
              ┌────▼────────────┐
              │ 3. 传输到主机   │
              │ adb pull        │
              └────┬────────────┘
                   │
              ┌────▼────────────┐
              │ 4. 解码图像     │
              │ PIL.Image.open()│
              └────┬────────────┘
                   │ (PIL Image)
              ┌────▼────────────┐
              │ 5. 缓存          │
              │ cache.set()     │
              └────┬────────────┘
                   │
输出: Screenshot (图像对象)

操作: tap(x, y)
执行: adb shell input tap x y
     (ADB 命令执行，无返回值)

操作: swipe(x1, y1, x2, y2, duration)
执行: adb shell input swipe x1 y1 x2 y2 duration

操作: send_text(text)
执行: 
  1. InputValidator.validate_text_input(text)
  2. adb shell input text "text"

操作: press_key(key_code)
执行: adb shell input keyevent key_code
```

---

## 时序图

### 3.1 完整任务执行时序图

```
用户          代理           模型            设备
 │             │              │               │
 │  run(task)  │              │               │
 ├────────────→│              │               │
 │             │              │               │
 │             │ __init__     │               │
 │             ├─────────────────────────────→│
 │             │              │               │
 │             │←─────────────────────────────┤
 │             │ device ready│               │
 │             │              │               │
 │             │ while step<max:             │
 │             │              │               │
 │             │ get_screenshot              │
 │             ├──────────────────────────────→│
 │             │              │               │
 │             │←──────────────────────────────┤
 │             │ screenshot   │               │
 │             │              │               │
 │             │────────────────────────────→ │
 │             │  image + prompt              │
 │             │              │ (HTTP POST)   │
 │             │              │               │
 │             │              │   推理...     │
 │             │              │   (1-5s)     │
 │             │              │               │
 │             │←─────────────────────────────│
 │             │  JSON action │               │
 │             │              │               │
 │             │ parse_action │               │
 │             │              │               │
 │             │ handle_action│               │
 │             ├──────────────────────────────→│
 │             │   ADB cmd    │               │
 │             │              │               │
 │             │←──────────────────────────────┤
 │             │   result     │               │
 │             │              │               │
 │             │ (记录性能)    │               │
 │             │              │               │
 │             │ [检查完成条件]               │
 │             │              │               │
 │             │ (继续循环或完成)             │
 │             │              │               │
 │←────────────┤              │               │
 │  结果       │              │               │
 │             │              │               │
```

### 3.2 错误处理时序图

```
用户          代理           模型            设备
 │             │              │               │
 │  run(task)  │              │               │
 ├────────────→│              │               │
 │             │              │               │
 │             │ 获取截图...  │               │
 │             ├──────────────────────────────→│
 │             │              │               │
 │             │              │    ✗ 错误    │
 │             │←──────────────────────────────┤
 │             │  设备离线     │               │
 │             │              │               │
 │             │ [捕获异常]   │               │
 │             │              │               │
 │             │ [日志记录]   │               │
 │             │              │               │
 │             │ [重试策略]   │               │
 │             │ retry=3      │               │
 │             │ delay=1s     │               │
 │             │              │               │
 │             │ 等待...      │               │
 │             │              │               │
 │             │ 重试获取截图 │               │
 │             ├──────────────────────────────→│
 │             │              │               │
 │             │              │    ✓ 成功    │
 │             │←──────────────────────────────┤
 │             │  screenshot  │               │
 │             │              │               │
 │             │ [继续流程]   │               │
 │             │              │               │
 │             │ (或最终失败)  │               │
 │             │              │               │
 │←────────────┤              │               │
 │  结果       │              │               │
 │             │              │               │
```

---

## 状态机

### 4.1 代理执行状态机

```
┌─────────────┐
│   初始化    │
│  (INIT)     │
└──────┬──────┘
       │ 配置验证通过
       ▼
┌─────────────────┐
│  就绪           │
│  (READY)        │
└──────┬──────────┘
       │ 用户提交任务
       ▼
┌─────────────────────────┐
│  运行中                 │
│  (RUNNING)              │
│  ├─ 获取截图           │
│  ├─ AI 推理             │
│  ├─ 解析动作           │
│  └─ 执行动作           │
└──┬────────────┬─────────┘
   │完成命令    │错误/超限
   │           │
   ▼           ▼
┌────────┐  ┌────────────┐
│ 完成   │  │ 错误       │
│(DONE) │  │ (ERROR)    │
└────────┘  └────────────┘
   │              │
   └───────┬──────┘
           │
           ▼
    ┌─────────────┐
    │  已重置     │
    │  (RESET)    │
    └────┬────────┘
         │ 可再次使用
         ▼
    ┌─────────────┐
    │   就绪      │
    │  (READY)    │
    └─────────────┘
```

### 4.2 步骤执行状态机

```
┌──────────┐
│  开始    │
│(START)   │
└────┬─────┘
     │
     ▼
┌──────────────────┐
│ 获取截图        │
│ (GET_SCREENSHOT) │
└────┬────────────┬┘
     │成功        │失败
     │            │
     ▼            ▼
┌──────────┐  ┌─────────┐
│ 推理中   │  │ 重试或  │
│(INFERRING)  │ 错误    │
└────┬─────┘  │(ERROR) │
     │        └────────┘
     ▼
┌──────────────┐
│ 解析动作    │
│ (PARSING)   │
└────┬──────┬─┘
     │成功  │失败
     │      │
     ▼      ▼
┌──────────┐ ┌────────┐
│ 执行    │ │ 错误   │
│ (EXECUTING) │ (ERROR) │
└────┬────┘ └────────┘
     │
     ▼
┌──────────────┐
│ 完成或继续   │
│ (DONE/NEXT)  │
└──────────────┘
```

---

## 部署架构

### 5.1 本地开发部署

```
┌─────────────────────────────────────────────────────────┐
│                  开发者工作站                           │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Python 虚拟环境 (.venv)                         │   │
│  │ ├─ Python 3.10+                                │   │
│  │ ├─ phone_agent 包 (editable)                   │   │
│  │ ├─ openai>=2.9.0                               │   │
│  │ ├─ Pillow>=12.0.0                              │   │
│  │ └─ pyyaml (可选)                               │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 源代码                                          │   │
│  │ ├─ main.py (入口)                               │   │
│  │ ├─ phone_agent/ (包)                            │   │
│  │ └─ examples/ (示例)                             │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 配置文件                                        │   │
│  │ ├─ .env (环境变量)                              │   │
│  │ ├─ config.json (JSON配置)                      │   │
│  │ └─ config.yaml (YAML配置)                      │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 日志和输出                                      │   │
│  │ ├─ logs/ (日志文件)                             │   │
│  │ ├─ 控制台输出 (stdout/stderr)                   │   │
│  │ └─ 性能报告 (metrics)                           │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└──────────┬──────────────────────┬──────────────────────┘
           │                      │
    USB/TCP│                      │ HTTP/HTTPS
           │                      │
           ▼                      ▼
┌──────────────────────┐  ┌──────────────────────┐
│  Android 设备        │  │  模型 API 服务       │
│  - 模拟器或真机     │  │  (vLLM/SGLang/...)   │
│  - ADB 端口 5037    │  │  或 OpenAI API       │
│  - 屏幕分辨率 XY    │  │                      │
│  - API 21+          │  │  • 推理能力          │
│  - 存储空间         │  │  • GPU/CPU           │
│  └──────────────────┘  └──────────────────────┘
```

### 5.2 生产部署架构

```
┌────────────────────────────────────────────────────────────┐
│                    互联网                                  │
│                    (Internet)                              │
└────────────┬─────────────────────────────────────────┬─────┘
             │                                         │
             │ HTTPS                           HTTPS  │
             │                                         │
┌────────────▼────────────┐            ┌──────────────▼─────┐
│  用户应用                │            │  模型推理服务       │
│  (User Application)    │            │  (Inference Server) │
│                         │            │                     │
│ • 前端 (Web/Mobile)    │            │ • vLLM/SGLang      │
│ • API 网关             │            │ • GPU 集群         │
│ • 请求队列             │            │ • 模型管理         │
└────────────┬────────────┘            └──────────────┬─────┘
             │                                        │
             │ 定向指令                               │
             │                                        │ 返回动作
             │                                        │
    ┌────────▼───────────────────────────────────────▼────┐
    │      Open-AutoGLM 代理服务                         │
    │      (Phone Agent Server/Cluster)                │
    │                                                  │
    │  ┌────────────────────────────────────────────┐ │
    │  │ 代理节点 1 - 设备 1-5                     │ │
    │  ├────────────────────────────────────────────┤ │
    │  │ • Python 进程                             │ │
    │  │ • 内存: 500MB-1GB                         │ │
    │  │ • ADB 连接: 5 台设备                      │ │
    │  │ • 日志: 文件存储                          │ │
    │  └────────────────────────────────────────────┘ │
    │                                                  │
    │  ┌────────────────────────────────────────────┐ │
    │  │ 代理节点 2 - 设备 6-10                    │ │
    │  ├────────────────────────────────────────────┤ │
    │  │ • Python 进程                             │ │
    │  │ • 内存: 500MB-1GB                         │ │
    │  │ • ADB 连接: 5 台设备                      │ │
    │  │ • 日志: 文件存储                          │ │
    │  └────────────────────────────────────────────┘ │
    │                                                  │
    │  ┌────────────────────────────────────────────┐ │
    │  │ 共享资源                                  │ │
    │  │ • 配置管理                                │ │
    │  │ • 日志聚合                                │ │
    │  │ • 监控和告警                              │ │
    │  │ • 性能指标                                │ │
    │  └────────────────────────────────────────────┘ │
    │                                                  │
    └────────────────┬─────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────────┐      ┌─────────────────┐
│ Android 设备集群 │      │ 监控面板        │
│ • 模拟器/真机    │      │ • Prometheus    │
│ • 100+ 台设备   │      │ • Grafana       │
│ • USB 集线器    │      │ • 告警规则      │
│ • 网络同步      │      │ • 实时仪表板    │
└──────────────────┘      └─────────────────┘
```

### 5.3 配置和环境

```
环境变量 (使用 .env 文件):

PHONE_AGENT_BASE_URL=http://localhost:8000/v1
PHONE_AGENT_API_KEY=sk-xxxx...
PHONE_AGENT_MODEL=autoglm-phone-9b
PHONE_AGENT_DEVICE_ID=emulator-5554
PHONE_AGENT_MAX_STEPS=100
PHONE_AGENT_LANG=cn
PHONE_AGENT_VERBOSE=true
PHONE_AGENT_LOG_LEVEL=DEBUG
PHONE_AGENT_LOG_FILE=logs/app.log


配置文件 (config.json):

{
  "model": {
    "base_url": "http://localhost:8000/v1",
    "api_key": "${PHONE_AGENT_API_KEY}",
    "model_name": "autoglm-phone-9b",
    "max_tokens": 3000,
    "temperature": 0.0,
    "top_p": 0.85
  },
  "agent": {
    "max_steps": 100,
    "device_id": "emulator-5554",
    "lang": "cn",
    "verbose": true
  },
  "logging": {
    "level": "DEBUG",
    "file": "logs/app.log",
    "format": "[%(asctime)s] [%(name)s] [%(levelname)s] %(message)s"
  },
  "cache": {
    "screenshot_cache_size": 5,
    "cache_ttl": 300
  }
}
```

---

完整的数据流与架构图设计至此完成。

