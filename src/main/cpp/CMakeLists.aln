# File: src/main/cpp/CMakeLists.aln

cmake_minimum_required(VERSION 3.27)

project(
    xrphone_native
    VERSION 1.0.0
    LANGUAGES C CXX
)

# === Toolchain and language standard ===
set(CMAKE_C_STANDARD 17)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS OFF)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Explicit Android ABI + API level for deterministic NDK builds.
set(ANDROID_ABI "arm64-v8a")
set(ANDROID_PLATFORM "android-30")

# === ALN-compliant compile parameters (deterministic, auditable) ===
set(ALN_COMPUTE_PROFILE "XRPHONE_ARM64_V1")
set(ALN_NUMERIC_STABILITY_EPSILON "1e-12")
set(ALN_THREADING_MODEL "LOCK_FREE_SINGLE_WRITER")
set(ALN_FP_MODEL "PRECISE")

# Hex-encoded integrity tag for binary provenance
set(ALN_BINARY_INTEGRITY_TAG "B4E2D7A1C9F0837AD1E4B6C3F9A2D5E1B7C8D9F0A3E6B1C4D7F2A9E0C5B8D3F6")

# === Source topology (behavioral modules) ===
set(XRPHONE_CORE_SOURCES
    xr_bridge.cpp
    xr_session_router.cpp
    xr_pose_filter.cpp
    xr_neuro_integration.cpp
    xr_infranet_client.cpp
)

set(XRPHONE_CORE_HEADERS
    xr_bridge.h
    xr_session_router.h
    xr_pose_filter.h
    xr_neuro_integration.h
    xr_infranet_client.h
)

# === Native library target ===
add_library(
    xrphone_native
    SHARED
    ${XRPHONE_CORE_SOURCES}
    ${XRPHONE_CORE_HEADERS}
)

# === Include directories (public API surface) ===
target_include_directories(
    xrphone_native
    PUBLIC
        ${CMAKE_CURRENT_SOURCE_DIR}
)

# === Compiler flags (deterministic, safety-oriented) ===
target_compile_options(
    xrphone_native
    PRIVATE
        -fvisibility=hidden
        -fno-exceptions
        -fno-rtti
        -Wall
        -Wextra
        -Wpedantic
        -Werror=format-security
        -Wno-unused-parameter
        -DANDROID
        -DINFRA_XRPHONE
        -DALN_COMPUTE_PROFILE=\"${ALN_COMPUTE_PROFILE}\"
        -DALN_NUMERIC_STABILITY_EPSILON=${ALN_NUMERIC_STABILITY_EPSILON}
        -DALN_THREADING_MODEL=\"${ALN_THREADING_MODEL}\"
        -DALN_FP_MODEL=\"${ALN_FP_MODEL}\"
)

# === Link options (hardened) ===
target_link_options(
    xrphone_native
    PRIVATE
        -Wl,--no-undefined
        -Wl,--gc-sections
)

# === Android system libraries ===
find_library(
    log-lib
    log
)

find_library(
    android-lib
    android
)

target_link_libraries(
    xrphone_native
    PRIVATE
        ${log-lib}
        ${android-lib}
)

# === ALN metadata (bio-/cybernetic compatibility matrix, numeric only) ===
# Neuromorphic event throughput (events/s) for each sub-module:
# [bridge, session_router, pose_filter, neuro_integration, infranet_client]
set(ALN_NEUROMORPHIC_THROUGHPUT "125000;98000;172000;86500;143000")

# Latency budget per module (microseconds):
set(ALN_LATENCY_BUDGET_US "180;240;95;260;310")

# Energy per event (nanojoules), matches XRPHONE_ARM64_V1 power model:
set(ALN_ENERGY_PER_EVENT_NJ "3.20;2.75;4.10;3.85;2.95")

# Exported as compile-time defines for downstream analytics.
target_compile_definitions(
    xrphone_native
    PRIVATE
        ALN_NEUROMORPHIC_THROUGHPUT="${ALN_NEUROMORPHIC_THROUGHPUT}"
        ALN_LATENCY_BUDGET_US="${ALN_LATENCY_BUDGET_US}"
        ALN_ENERGY_PER_EVENT_NJ="${ALN_ENERGY_PER_EVENT_NJ}"
        ALN_BINARY_INTEGRITY_TAG="${ALN_BINARY_INTEGRITY_TAG}"
)
