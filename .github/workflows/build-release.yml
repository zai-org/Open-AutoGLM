# GitHub Actions Workflow: è·¨å¹³å°æ„å»ºä¸è‡ªåŠ¨å‘å¸ƒ
# ç”¨äºè‡ªåŠ¨ä½¿ç”¨ PyInstaller æ„å»ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶å¹¶å‘å¸ƒåˆ° GitHub Releases
#
# è§¦å‘æ–¹å¼:
#   - workflow_dispatch: æ‰‹åŠ¨è§¦å‘
#   - schedule: æ¯æ—¥å®šæ—¶æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
#   - push: æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆé€‚ç”¨äºåŒæ­¥ Fork åœºæ™¯ï¼‰

name: Build and Release

on:
  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒè‡ªå®šä¹‰ç‰ˆæœ¬å·
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'å¯é€‰çš„ç‰ˆæœ¬å·åç¼€ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰'
        required: false
        default: ''
      pre_release:
        description: 'æ˜¯å¦æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤© UTC æ—¶é—´ 00:00ï¼Œå³åŒ—äº¬æ—¶é—´ 08:00ï¼‰
  # å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„ schedule ä»¥å¯ç”¨å®šæ—¶æ„å»º
  # schedule:
  #   - cron: '0 0 * * *'

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆé€‚ç”¨äºåŒæ­¥ä¸Šæ¸¸åè‡ªåŠ¨æ„å»ºï¼‰
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - '.github/copilot-instructions.md'

# ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ„å»ºä»»åŠ¡è¿è¡Œ
concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  PROJECT_NAME: 'phone-agent'

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šç”Ÿæˆç‰ˆæœ¬å·
  prepare:
    name: Prepare Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if build is needed
        id: check
        run: |
          # å¯¹äº workflow_dispatch å’Œ scheduleï¼Œæ€»æ˜¯æ„å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å¯¹äº push äº‹ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§æ›´æ”¹
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if [[ -n "$CHANGED_FILES" ]]; then
            # æ’é™¤çº¯æ–‡æ¡£æ›´æ”¹
            CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -v -E '\.md$|^docs/|^\.github/(ISSUE_TEMPLATE|PULL_REQUEST_TEMPLATE|copilot)' || true)
            if [[ -n "$CODE_CHANGES" ]]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate version number
        id: version
        run: |
          # æ ¼å¼: vYYYYMMDD-HHMM
          VERSION="v$(date -u +'%Y%m%d-%H%M')"
          
          # å¦‚æœæä¾›äº†è‡ªå®šä¹‰åç¼€ï¼Œåˆ™é™„åŠ 
          if [[ -n "${{ github.event.inputs.version_suffix }}" ]]; then
            VERSION="${VERSION}-${{ github.event.inputs.version_suffix }}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Build version: ${VERSION}"

  # æ„å»ºé˜¶æ®µï¼šå¤šå¹³å°çŸ©é˜µæ„å»º
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS x64
          - os: macos
            arch: x64
            runner: macos-13
            artifact_name: phone-agent-macos-x64
            executable_ext: ''
          
          # macOS ARM64 (Apple Silicon)
          - os: macos
            arch: arm64
            runner: macos-14
            artifact_name: phone-agent-macos-arm64
            executable_ext: ''
          
          # Linux x64
          - os: linux
            arch: x64
            runner: ubuntu-22.04
            artifact_name: phone-agent-linux-x64
            executable_ext: ''
          
          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            artifact_name: phone-agent-linux-arm64
            executable_ext: ''
          
          # Windows x64
          - os: windows
            arch: x64
            runner: windows-latest
            artifact_name: phone-agent-windows-x64
            executable_ext: '.exe'
          
          # Windows ARM64
          - os: windows
            arch: arm64
            runner: windows-11-arm
            artifact_name: phone-agent-windows-arm64
            executable_ext: '.exe'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~/AppData/Local/pip/Cache
          key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-pip-

      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: |
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…é¡¹ç›®ä¾èµ–
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          
          # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£… PyInstaller
          pip install pyinstaller

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…é¡¹ç›®ä¾èµ–
          python -m venv .venv
          .\.venv\Scripts\Activate.ps1
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          
          # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£… PyInstaller
          pip install pyinstaller

      - name: Build with PyInstaller (Unix)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          
          # ä½¿ç”¨ PyInstaller æ„å»º
          pyinstaller \
            --name="${{ env.PROJECT_NAME }}" \
            --onefile \
            --clean \
            --noconfirm \
            --add-data="phone_agent:phone_agent" \
            --add-data="resources:resources" \
            --hidden-import="phone_agent" \
            --hidden-import="phone_agent.agent" \
            --hidden-import="phone_agent.model" \
            --hidden-import="phone_agent.model.client" \
            --hidden-import="phone_agent.adb" \
            --hidden-import="phone_agent.adb.connection" \
            --hidden-import="phone_agent.adb.device" \
            --hidden-import="phone_agent.adb.input" \
            --hidden-import="phone_agent.adb.screenshot" \
            --hidden-import="phone_agent.actions" \
            --hidden-import="phone_agent.actions.handler" \
            --hidden-import="phone_agent.config" \
            --hidden-import="phone_agent.config.apps" \
            --hidden-import="phone_agent.config.i18n" \
            --hidden-import="phone_agent.config.prompts" \
            --hidden-import="phone_agent.config.prompts_en" \
            --hidden-import="phone_agent.config.prompts_zh" \
            --hidden-import="PIL" \
            --hidden-import="openai" \
            --collect-all="phone_agent" \
            main.py
          
          # éªŒè¯æ„å»ºäº§ç‰©
          ls -la dist/
          ./dist/${{ env.PROJECT_NAME }} --help || echo "Help command executed"

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .\.venv\Scripts\Activate.ps1
          
          # ä½¿ç”¨ PyInstaller æ„å»º
          pyinstaller `
            --name="${{ env.PROJECT_NAME }}" `
            --onefile `
            --clean `
            --noconfirm `
            --add-data="phone_agent;phone_agent" `
            --add-data="resources;resources" `
            --hidden-import="phone_agent" `
            --hidden-import="phone_agent.agent" `
            --hidden-import="phone_agent.model" `
            --hidden-import="phone_agent.model.client" `
            --hidden-import="phone_agent.adb" `
            --hidden-import="phone_agent.adb.connection" `
            --hidden-import="phone_agent.adb.device" `
            --hidden-import="phone_agent.adb.input" `
            --hidden-import="phone_agent.adb.screenshot" `
            --hidden-import="phone_agent.actions" `
            --hidden-import="phone_agent.actions.handler" `
            --hidden-import="phone_agent.config" `
            --hidden-import="phone_agent.config.apps" `
            --hidden-import="phone_agent.config.i18n" `
            --hidden-import="phone_agent.config.prompts" `
            --hidden-import="phone_agent.config.prompts_en" `
            --hidden-import="phone_agent.config.prompts_zh" `
            --hidden-import="PIL" `
            --hidden-import="openai" `
            --collect-all="phone_agent" `
            main.py
          
          # éªŒè¯æ„å»ºäº§ç‰©
          Get-ChildItem dist/
          .\dist\${{ env.PROJECT_NAME }}.exe --help

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p artifact
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp "dist/${{ env.PROJECT_NAME }}${{ matrix.executable_ext }}" "artifact/${{ matrix.artifact_name }}${{ matrix.executable_ext }}"
          else
            cp "dist/${{ env.PROJECT_NAME }}" "artifact/${{ matrix.artifact_name }}"
            chmod +x "artifact/${{ matrix.artifact_name }}"
          fi
          
          # å¤åˆ¶å¿…è¦çš„èµ„æºæ–‡ä»¶
          cp README.md artifact/ || true
          cp LICENSE artifact/ || true
          
          # æ˜¾ç¤ºäº§ç‰©ä¿¡æ¯
          ls -la artifact/

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          cd artifact
          tar -czvf "../${{ matrix.artifact_name }}.tar.gz" .
          cd ..
          ls -la *.tar.gz

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path artifact\* -DestinationPath "${{ matrix.artifact_name }}.zip"
          Get-ChildItem *.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.gz
            ${{ matrix.artifact_name }}.zip
          if-no-files-found: error
          retention-days: 7

  # å‘å¸ƒé˜¶æ®µï¼šåˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: [prepare, build]
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # ç§»åŠ¨æ‰€æœ‰æ„å»ºäº§ç‰©åˆ° release-assets ç›®å½•
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release-assets/ \;
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
          cd ..
          
          # æ˜¾ç¤ºæ‰€æœ‰å‘å¸ƒèµ„äº§
          echo "ğŸ“¦ Release assets:"
          ls -la release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          cat << EOF > release_notes.md
          ## ğŸš€ Phone Agent ${VERSION}
          
          ### ğŸ“¦ ä¸‹è½½
          
          | å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |
          |------|------|----------|
          | macOS | x64 (Intel) | \`phone-agent-macos-x64.tar.gz\` |
          | macOS | ARM64 (Apple Silicon) | \`phone-agent-macos-arm64.tar.gz\` |
          | Linux | x64 | \`phone-agent-linux-x64.tar.gz\` |
          | Linux | ARM64 | \`phone-agent-linux-arm64.tar.gz\` |
          | Windows | x64 | \`phone-agent-windows-x64.zip\` |
          | Windows | ARM64 | \`phone-agent-windows-arm64.zip\` |
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          
          #### macOS / Linux
          \`\`\`bash
          # è§£å‹
          tar -xzf phone-agent-<platform>-<arch>.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
          chmod +x phone-agent-<platform>-<arch>
          
          # è¿è¡Œ
          ./phone-agent-<platform>-<arch> --help
          \`\`\`
          
          #### Windows
          \`\`\`powershell
          # è§£å‹ zip æ–‡ä»¶
          Expand-Archive phone-agent-windows-<arch>.zip -DestinationPath .
          
          # è¿è¡Œ
          .\phone-agent-windows-<arch>.exe --help
          \`\`\`
          
          ### âš ï¸ è¿è¡Œå‰æ
          
          - ç¡®ä¿ ADB å·¥å…·å·²å®‰è£…å¹¶åœ¨ PATH ä¸­
          - ç¡®ä¿ Android è®¾å¤‡å·²é€šè¿‡ USB æˆ– WiFi è¿æ¥
          - ç¡®ä¿è®¾å¤‡ä¸Šå·²å®‰è£…å¹¶å¯ç”¨ ADB Keyboard
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}
          - æäº¤: ${{ github.sha }}
          EOF
          
          echo "Release notes generated."

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: Phone Agent ${{ needs.prepare.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.pre_release == 'true' }}
          files: release-assets/*
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Summary
        run: |
          echo "## ğŸ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Assets:**" >> $GITHUB_STEP_SUMMARY
          ls -1 release-assets/ | while read file; do
            echo "- \`${file}\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }})" >> $GITHUB_STEP_SUMMARY

  # æ¸…ç†é˜¶æ®µï¼šåˆ é™¤è¿‡æœŸçš„ artifacts
  cleanup:
    name: Cleanup
    needs: [release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Delete workflow artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            phone-agent-*
          failOnError: false
